/* ads.js â€” OTI Ads Rail/Dock (HOT AD / BOTTOM AD framing, safe + simple) */
(() => {
  const MANIFEST_PATH = 'ads-manifest.json';   // same folder as index.html
  const IMG_BASE = 'media/';                   // fixed: relative path for /oti/ deployment
  const LINK_BASE = './';                      // flat links

  const SELECTOR_RAIL = '#ads-rail';
  const SELECTOR_DOCK = '#ads-dock';

  const SPEED = 0.3;
  const REDUCED_MOTION = window.matchMedia?.('(prefers-reduced-motion: reduce)').matches === true;

  const FALLBACK_MANIFEST = [
    'Angels-AD.jpg',
    'patriot-beer-AD.jpg',
    'patriot-games-AD.jpg',
    'you-AD-here.jpg',
    'blacks-love-grundy-AD.jpg',
    'OTI-premium-AD.jpg',
    'grundymax-AD.jpg',
    'golden-streets-AD.jpg',
    'cover-AD.jpg',
    'primate-guidelines-AD.jpg',
    'grundy-glow-AD.jpg'
  ];

  const el = (tag, { class: cls, attrs, text, children } = {}) => {
    const n = document.createElement(tag);
    if (cls) n.className = cls;
    if (attrs) for (const [k, v] of Object.entries(attrs)) n.setAttribute(k, v);
    if (text != null) n.textContent = text;
    if (children) children.forEach(c => c && n.appendChild(c));
    return n;
  };

  const toSlug = (file) => file.replace(/\.jpg$/i, '');

  const buildTile = (file) => {
    const slug = toSlug(file);
    const href = `${LINK_BASE}${slug}.html`;
    const src = `${IMG_BASE}${file}`;

    const img = el('img', {
      class: 'ad-img',
      attrs: { src, loading: 'lazy', decoding: 'async', alt: '' }
    });

    const pill = el('span', { class: 'ad-pill', text: 'Financial Patriotism' });

    return el('a', {
      class: 'ad-tile',
      attrs: { href, 'aria-label': slug },
      children: [img, pill]
    });
  };

  const buildFixedTile = (label) => {
    const h = el('div', { class: 'ad-fixed-label', text: label });
    const pill = el('span', { class: 'ad-pill', text: 'Financial Patriotism' });
    return el('div', { class: 'ad-fixed', children: [h, pill] });
  };

  async function loadManifest(path) {
    try {
      const res = await fetch(path, { credentials: 'same-origin' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      if (!Array.isArray(data)) throw new Error('manifest must be an array');
      return data.filter(n => /\.jpg$/i.test(n));
    } catch {
      return FALLBACK_MANIFEST;
    }
  }

  function attachDamping(container, axis) {
    if (REDUCED_MOTION || !container) return;
    container.addEventListener('wheel', (e) => {
      if (e.ctrlKey || e.metaKey) return;
      e.preventDefault();
      const raw = axis === 'x'
        ? (Math.abs(e.deltaX) > Math.abs(e.deltaY) ? e.deltaX : e.deltaY)
        : e.deltaY;
      const scaled = raw * SPEED;
      if (axis === 'x') container.scrollLeft += scaled; else container.scrollTop += scaled;
    }, { passive: false });

    let active = false, startX = 0, startY = 0, baseLeft = 0, baseTop = 0;
    container.addEventListener('pointerdown', (e) => {
      if (e.pointerType === 'touch' || e.pointerType === 'pen') {
        active = true; startX = e.clientX; startY = e.clientY;
        baseLeft = container.scrollLeft; baseTop = container.scrollTop;
        container.setPointerCapture?.(e.pointerId);
      }
    });
    container.addEventListener('pointermove', (e) => {
      if (!active) return;
      if (e.pointerType === 'touch' || e.pointerType === 'pen') {
        e.preventDefault();
        const dx = (e.clientX - startX) * SPEED;
        const dy = (e.clientY - startY) * SPEED;
        if (axis === 'x') container.scrollLeft = baseLeft - dx; else container.scrollTop = baseTop - dy;
      }
    }, { passive: false });
    const stop = () => { active = false; };
    container.addEventListener('pointerup', stop);
    container.addEventListener('pointercancel', stop);
  }

  function mountDesktopRail(rail, files) {
    if (!rail) return;
    rail.innerHTML = '';

    const fixedTop = buildFixedTile('HOT AD');
    const fixedBottom = buildFixedTile('BOTTOM AD');
    const scroller = el('div', { class: 'ad-scroll', attrs: { tabindex: '0', 'aria-label': 'Sponsored stories' } });

    const frag = document.createDocumentFragment();
    files.forEach(f => frag.appendChild(buildTile(f)));
    scroller.appendChild(frag);

    rail.appendChild(fixedTop);
    rail.appendChild(scroller);
    rail.appendChild(fixedBottom);

    attachDamping(scroller, 'y');

    rail.setAttribute('data-live', '1');
  }

  function mountMobileDock(dock, files) {
    if (!dock) return;
    dock.innerHTML = '';

    const track = el('div', { class: 'ad-track', attrs: { tabindex: '0', 'aria-label': 'Sponsored stories' } });
    const frag = document.createDocumentFragment();
    files.forEach(f => frag.appendChild(buildTile(f)));
    track.appendChild(frag);
    dock.appendChild(track);

    attachDamping(track, 'x');
  }

  async function init() {
    const rail = document.querySelector(SELECTOR_RAIL);
    const dock = document.querySelector(SELECTOR_DOCK);
    if (!rail && !dock) return;

    const files = await loadManifest(MANIFEST_PATH);

    if (rail) mountDesktopRail(rail, files);
    if (dock) mountMobileDock(dock, files);

    window.OTIAds = {
      refresh: async () => {
        const fresh = await loadManifest(MANIFEST_PATH);
        if (rail) mountDesktopRail(rail, fresh);
        if (dock) mountMobileDock(dock, fresh);
      }
    };
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init, { once: true });
  } else {
    init();
  }
})();
